---
- name: Deploy Demo App (Paulbouwer)
  hosts: k8s_master
  become: yes
  tasks:
    - name: Deploy App and Service
      shell: |
        export KUBECONFIG=/etc/kubernetes/admin.conf
        
        # Удаляем старое (чтобы не было конфликтов портов)
        kubectl delete deployment demo-app --ignore-not-found=true
        kubectl delete service demo-app --ignore-not-found=true
        kubectl delete deployment hello-kubernetes --ignore-not-found=true
        kubectl delete service hello-kubernetes-service --ignore-not-found=true
        
        # Применяем манифест из методички (через cat <<EOF)
        cat <<EOF | kubectl apply -f -
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: hello-kubernetes
        spec:
          replicas: 2
          selector:
            matchLabels:
              app: hello-kubernetes
          template:
            metadata:
              labels:
                app: hello-kubernetes
            spec:
              containers:
              - name: hello-kubernetes
                image: paulbouwer/hello-kubernetes:1.10
                ports:
                - containerPort: 8080
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: hello-kubernetes-service
        spec:
          ports:
          - port: 80
            targetPort: 8080
          selector:
            app: hello-kubernetes
        EOF
