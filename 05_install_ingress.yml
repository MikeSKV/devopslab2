---
- name: Install Ingress Controller (Mirror Fix)
  hosts: k8s_master
  become: yes
  tasks:
    # 0. Fix DNS (на всякий случай повторяем)
    - name: Fix DNS resolver
      shell: echo "nameserver 8.8.8.8" > /etc/resolv.conf

    # 1. Создаем манифест вручную (с правильным зеркалом)
    - name: Create Clean Ingress Manifest
      copy:
        dest: /tmp/ingress-clean.yaml
        content: |
          apiVersion: v1
          kind: Namespace
          metadata:
            name: ingress-nginx
            labels:
              app.kubernetes.io/name: ingress-nginx
              app.kubernetes.io/instance: ingress-nginx
          ---
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            labels:
              app.kubernetes.io/name: ingress-nginx
              app.kubernetes.io/instance: ingress-nginx
            name: ingress-nginx
            namespace: ingress-nginx
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            labels:
              app.kubernetes.io/name: ingress-nginx
              app.kubernetes.io/instance: ingress-nginx
            name: ingress-nginx
          rules:
          - apiGroups: [""]
            resources: ["configmaps", "endpoints", "nodes", "pods", "secrets", "namespaces", "services"]
            verbs: ["list", "watch", "get"]
          - apiGroups: ["networking.k8s.io"]
            resources: ["ingresses", "ingresses/status", "ingressclasses"]
            verbs: ["get", "list", "watch", "update"]
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            labels:
              app.kubernetes.io/name: ingress-nginx
              app.kubernetes.io/instance: ingress-nginx
            name: ingress-nginx
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: ingress-nginx
          subjects:
          - kind: ServiceAccount
            name: ingress-nginx
            namespace: ingress-nginx
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: Role
          metadata:
            labels:
              app.kubernetes.io/name: ingress-nginx
              app.kubernetes.io/instance: ingress-nginx
            name: ingress-nginx
            namespace: ingress-nginx
          rules:
          - apiGroups: [""]
            resources: ["namespaces", "configmaps", "pods", "secrets", "endpoints", "services"]
            verbs: ["get", "list", "watch"]
          - apiGroups: ["networking.k8s.io"]
            resources: ["ingresses", "ingresses/status", "ingressclasses"]
            verbs: ["get", "list", "watch", "update"]
          - apiGroups: ["coordination.k8s.io"]
            resources: ["leases"]
            verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
          - apiGroups: ["discovery.k8s.io"]
            resources: ["endpointslices"]
            verbs: ["get", "list", "watch"]
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: RoleBinding
          metadata:
            labels:
              app.kubernetes.io/name: ingress-nginx
              app.kubernetes.io/instance: ingress-nginx
            name: ingress-nginx
            namespace: ingress-nginx
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: Role
            name: ingress-nginx
          subjects:
          - kind: ServiceAccount
            name: ingress-nginx
            namespace: ingress-nginx
          ---
          apiVersion: v1
          kind: Service
          metadata:
            labels:
              app.kubernetes.io/name: ingress-nginx
              app.kubernetes.io/instance: ingress-nginx
            name: ingress-nginx-controller
            namespace: ingress-nginx
          spec:
            type: NodePort
            ports:
            - name: http
              port: 80
              protocol: TCP
              targetPort: http
            - name: https
              port: 443
              protocol: TCP
              targetPort: https
            selector:
              app.kubernetes.io/name: ingress-nginx
              app.kubernetes.io/instance: ingress-nginx
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            labels:
              app.kubernetes.io/name: ingress-nginx
              app.kubernetes.io/instance: ingress-nginx
            name: ingress-nginx-controller
            namespace: ingress-nginx
          spec:
            selector:
              matchLabels:
                app.kubernetes.io/name: ingress-nginx
                app.kubernetes.io/instance: ingress-nginx
            replicas: 1
            template:
              metadata:
                labels:
                  app.kubernetes.io/name: ingress-nginx
                  app.kubernetes.io/instance: ingress-nginx
              spec:
                dnsPolicy: ClusterFirst
                containers:
                - name: controller
                  # ИСПОЛЬЗУЕМ ЗЕРКАЛО, КОТОРОЕ ТОЧНО РАБОТАЕТ
                  image: liyanghz/ingress-nginx-controller:v1.10.1
                  imagePullPolicy: IfNotPresent
                  lifecycle:
                    preStop:
                      exec:
                        command:
                        - /wait-shutdown
                  args:
                  - /nginx-ingress-controller
                  - --election-id=ingress-controller-leader
                  - --controller-class=k8s.io/ingress-nginx
                  - --ingress-class=nginx
                  - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller
                  securityContext:
                    capabilities:
                      drop:
                      - ALL
                      add:
                      - NET_BIND_SERVICE
                    runAsUser: 101
                    allowPrivilegeEscalation: true
                  env:
                  - name: POD_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.name
                  - name: POD_NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                  - name: LD_PRELOAD
                    value: /usr/local/lib/libmimalloc.so
                  ports:
                  - name: http
                    containerPort: 80
                    protocol: TCP
                  - name: https
                    containerPort: 443
                    protocol: TCP
                  - name: webhook
                    containerPort: 8443
                    protocol: TCP
                  resources:
                    requests:
                      cpu: 100m
                      memory: 90Mi
                serviceAccountName: ingress-nginx
                terminationGracePeriodSeconds: 300
          ---
          apiVersion: networking.k8s.io/v1
          kind: IngressClass
          metadata:
            labels:
              app.kubernetes.io/name: ingress-nginx
              app.kubernetes.io/instance: ingress-nginx
            name: nginx
          spec:
            controller: k8s.io/ingress-nginx

    # 2. Очистка старого (если зависло)
    - name: Cleanup old Ingress
      shell: |
        export KUBECONFIG=/etc/kubernetes/admin.conf
        kubectl delete namespace ingress-nginx --ignore-not-found=true --timeout=10s
        sleep 10
      ignore_errors: yes

    # 3. Применяем
    - name: Apply Clean Ingress Manifest
      shell: |
        export KUBECONFIG=/etc/kubernetes/admin.conf
        kubectl apply -f /tmp/ingress-clean.yaml

    # 4. Ждем
    - name: Wait for Ingress ready
      shell: |
        export KUBECONFIG=/etc/kubernetes/admin.conf
        kubectl wait --namespace ingress-nginx \
          --for=condition=ready pod \
          --selector=app.kubernetes.io/component=controller \
          --timeout=300s
      ignore_errors: yes
