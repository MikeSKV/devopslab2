---
- name: Install Ingress Controller (v1.9.4 + AliCloud Mirror)
  hosts: k8s_master
  become: yes
  tasks:
    - name: Create Clean Ingress Manifest (v1.9.4)
      copy:
        dest: /tmp/ingress-clean.yaml
        content: |
          apiVersion: v1
          kind: Namespace
          metadata:
            name: ingress-nginx
          ---
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: ingress-nginx
            namespace: ingress-nginx
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: ingress-nginx
          rules:
          - apiGroups: [""]
            resources: ["configmaps", "endpoints", "nodes", "pods", "secrets", "namespaces", "services"]
            verbs: ["list", "watch", "get"]
          - apiGroups: ["networking.k8s.io"]
            resources: ["ingresses", "ingresses/status", "ingressclasses"]
            verbs: ["get", "list", "watch", "update"]
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: ingress-nginx
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: ingress-nginx
          subjects:
          - kind: ServiceAccount
            name: ingress-nginx
            namespace: ingress-nginx
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: Role
          metadata:
            name: ingress-nginx
            namespace: ingress-nginx
          rules:
          - apiGroups: [""]
            resources: ["namespaces", "configmaps", "pods", "secrets", "endpoints", "services"]
            verbs: ["get", "list", "watch"]
          - apiGroups: ["networking.k8s.io"]
            resources: ["ingresses", "ingresses/status", "ingressclasses"]
            verbs: ["get", "list", "watch", "update"]
          - apiGroups: ["coordination.k8s.io"]
            resources: ["leases"]
            verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: RoleBinding
          metadata:
            name: ingress-nginx
            namespace: ingress-nginx
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: Role
            name: ingress-nginx
          subjects:
          - kind: ServiceAccount
            name: ingress-nginx
            namespace: ingress-nginx
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: ingress-nginx-controller
            namespace: ingress-nginx
          spec:
            type: NodePort
            ports:
            - name: http
              port: 80
              targetPort: 80
            - name: https
              port: 443
              targetPort: 443
            selector:
              app.kubernetes.io/name: ingress-nginx
              app.kubernetes.io/instance: ingress-nginx
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ingress-nginx-controller
            namespace: ingress-nginx
            labels:
              app.kubernetes.io/name: ingress-nginx
              app.kubernetes.io/instance: ingress-nginx
          spec:
            replicas: 1
            selector:
              matchLabels:
                app.kubernetes.io/name: ingress-nginx
                app.kubernetes.io/instance: ingress-nginx
            template:
              metadata:
                labels:
                  app.kubernetes.io/name: ingress-nginx
                  app.kubernetes.io/instance: ingress-nginx
              spec:
                containers:
                - name: controller
                  # ИСПОЛЬЗУЕМ ЗЕРКАЛО ALIBABA CLOUD (google_containers mirror)
                  image: registry.aliyuncs.com/google_containers/nginx-ingress-controller:v1.9.4
                  imagePullPolicy: IfNotPresent
                  args:
                  - /nginx-ingress-controller
                  - --election-id=ingress-controller-leader
                  - --controller-class=k8s.io/ingress-nginx
                  - --ingress-class=nginx
                  - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller
                  securityContext:
                    runAsUser: 101
                    allowPrivilegeEscalation: true
                    capabilities:
                      drop: [ALL]
                      add: [NET_BIND_SERVICE]
                  env:
                  - name: POD_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.name
                  - name: POD_NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                  ports:
                  - name: http
                    containerPort: 80
                  - name: https
                    containerPort: 443
                serviceAccountName: ingress-nginx
          ---
          apiVersion: networking.k8s.io/v1
          kind: IngressClass
          metadata:
            name: nginx
          spec:
            controller: k8s.io/ingress-nginx

    - name: Cleanup old Ingress
      shell: |
        export KUBECONFIG=/etc/kubernetes/admin.conf
        kubectl delete namespace ingress-nginx --ignore-not-found=true --timeout=10s
        sleep 10
      ignore_errors: yes

    - name: Apply Clean Ingress Manifest
      shell: |
        export KUBECONFIG=/etc/kubernetes/admin.conf
        kubectl apply -f /tmp/ingress-clean.yaml

    - name: Wait for Ingress ready
      shell: |
        export KUBECONFIG=/etc/kubernetes/admin.conf
        # Добавляем sleep, чтобы поды успели создаться перед проверкой
        sleep 10 
        kubectl wait --namespace ingress-nginx \
          --for=condition=ready pod \
          --selector=app.kubernetes.io/instance=ingress-nginx \
          --timeout=300s
      ignore_errors: yes
