---
- name: Install Ingress Controller (No Webhook - Best for Lab)
  hosts: k8s_master
  become: yes
  tasks:
    # 0. Временный фикс DNS
    - name: Fix DNS resolver
      shell: echo "nameserver 8.8.8.8" > /etc/resolv.conf

    # 1. Скачиваем манифест
    - name: Download Ingress Manifest
      get_url:
        url: https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.10.1/deploy/static/provider/baremetal/deploy.yaml
        dest: /tmp/ingress-deploy.yaml

    # 2. МЕНЯЕМ ОБРАЗ КОНТРОЛЛЕРА на доступный
    - name: Replace Controller Image
      replace:
        path: /tmp/ingress-deploy.yaml
        regexp: 'registry.k8s.io/ingress-nginx/controller:v1.10.1.*'
        replace: 'docker.io/ingressnginx/controller:v1.10.1'

    # 3. УДАЛЯЕМ WEBHOOK CONFIGURATION (чтобы не запускать проблемные джобы)
    # Это грубый, но эффективный метод для лабы. Мы просто закомментируем секцию ValidatingWebhookConfiguration
    - name: Remove ValidatingWebhookConfiguration
      shell: |
        sed -i '/kind: ValidatingWebhookConfiguration/,/---/d' /tmp/ingress-deploy.yaml
        # Также удаляем Job-ы, которые создают сертификаты (они нам теперь не нужны)
        sed -i '/kind: Job/,/---/d' /tmp/ingress-deploy.yaml
        sed -i '/kind: Job/,/---/d' /tmp/ingress-deploy.yaml 

    # 4. Применяем
    - name: Apply Ingress Manifest
      shell: |
        export KUBECONFIG=/etc/kubernetes/admin.conf
        
        # Сначала удалим ВСЁ старое, чтобы убить висящие джобы
        kubectl delete -f /tmp/ingress-deploy.yaml --ignore-not-found=true
        kubectl delete jobs -n ingress-nginx --all --ignore-not-found=true
        
        # Применяем облегченный манифест
        kubectl apply -f /tmp/ingress-deploy.yaml

    # 5. Ждем
    - name: Wait for Ingress ready
      shell: |
        export KUBECONFIG=/etc/kubernetes/admin.conf
        kubectl wait --namespace ingress-nginx \
          --for=condition=ready pod \
          --selector=app.kubernetes.io/component=controller \
          --timeout=300s
      ignore_errors: yes
